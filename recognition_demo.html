<!--
-- Author:  Robert Derveloy
-- Written: 2013-01-15
-- 
-- Copyright (c) 2013-2015 -  Robert Derveloy
-- 
-- This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
-- To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/.
--
-->
<!DOCTYPE html>
<html>
<head>
    <title>JavaScript Speech API Library Demo</title>
</head>
<body>
<section id="section_NoJSWarning">
    <div id="div_NoJavaScriptWarning">
        <p>
            Sorry!  Your browser does not appear to have JavaScript enabled.  Please enable JavaScript in your browser for this site to function correctly.
        </p>
        <p>
            If your browser is incapable of running JavaScript, please see  <a href="http://caniuse.com/#feat=speech-synthesis" target="_blank">caniuse.com</a> for a list of compatible browsers.
        </p>
    </div>
</section>
<section id="section_STT">
    <div id="div_STTNotSupportedWarning" style="display:none;">
        <p>OOPS!</p>
        <p>Your browser does not appear to support the Speech Recognition API.  Please see  <a href="http://caniuse.com/#feat=speech-recognition" target="_blank">caniuse.com</a> for a list of capable browsers.</p>
    </div>
    <div id="div_sttInputs" style="display:none;">
        <p>
            <button id='button_sttStart' onclick="recognitionStartClickEventHandler();">Start Recognition</button>
            <button id='button_sttStop' onclick="recognitionStopClickEventHandler();" style="display:none;">Stop Recognition</button>
        </p>
        <p>
            <label>Interim Transcript:
            <textarea id='textarea_interimTranscript' rows='2' cols='50' readonly></textarea>
            </label>
        </p>
        <p>
            <label>Final Transcript:
            <textarea id='textarea_finalTranscript' rows='5' cols='50' readonly></textarea>
            </label>
        </p>
    </div>
    <br />
    <br />
</section>
<footer>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <br />
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">
                JavaScript Speech API Library
            </span>
    by
    <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/rderveloy/JavaScript-Speech-API-Library/" property="cc:attributionName" rel="cc:attributionURL">Robert Derveloy</a>
    is licensed under a
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
        Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License
    </a>.
</footer>
<script src='SpeechAPILibrary.js'></script>
<script>
    var elementToHideID = "div_NoJavaScriptWarning";
    var elementToShowID = null;
    document.getElementById(elementToHideID).style.display="none";

    //Here we detect if speech synthesis is supported by the client browser:
    if(SpeechAPI.SpeechRecognition.isSupported())
    {
        //If it's supported, we need to update our UI:
        console.log("STT Supported!");
        elementToShowID = "div_sttInputs";
    }
    else
    {
        //If it's not supported, let the end user know:
        console.log("STT Not Supported!");
        elementToShowID = "div_STTNotSupportedWarning";
    }
    document.getElementById(elementToShowID).style.display="block";

</script>
<script>

    //TODO: Continue session when ended without request or error.
    //TODO: Appropriately hide/show buttons in onstart and onend event handlers.
    //TODO: Reset final transcript when user ends session.

    var interimTranscript = "";
    var finalTranscript   = "";
    var IGNORE_SPOKEN_PUNCTUATION_COMMANDS = true;
    var test = new SpeechAPI.SpeechRecognition.ContinuousSession();


    test.setEventHandler_onend(function onEndEventHandler(event){
        console.log("Recognition ended.");
        console.log("Stop Requested: "+test.stopRequested());

        console.log(event);

        var elementToHideID = "button_sttStop";
        var elementToShowID = "button_sttStart";

        document.getElementById(elementToHideID).style.display="none";
        document.getElementById(elementToShowID).style.display="block";
    });

    test.setEventHandler_onstart(function onStartEventHandler(event){
        console.log("Recognition started.");
        console.log("Start Requested: "+test.startRequested());
    });

    test.setEventHandler_onerror(function onErrorEventHandler(event){
        console.log("Recognition error!");
        //TODO: Update ui for error messages.
    });

    test.setEventHandler_onresult(function onResultEventHandler(event){
        console.log("Recognition result!");

        console.log(event);

        var INTERIM_TRANSCRIPT_TEXTAREA_ID = "textarea_interimTranscript";
        var FINAL_TRANSCRIPT_TEXTAREA_ID   = "textarea_finalTranscript";

        var resultIndex       = event.resultIndex;
        var resultArrayLength = event.results.length;

        interimTranscript = "";
        test.resetInterimTranscriptToEmptyString();

        for (var currentIndex=resultIndex; currentIndex < resultArrayLength; ++currentIndex)
        {
            var currentRecognitionResult             = event.results[currentIndex];
            var currentRecognitionResultAlternative  = currentRecognitionResult[0];
            var transcriptToAppend                   = currentRecognitionResultAlternative.transcript;

            if(IGNORE_SPOKEN_PUNCTUATION_COMMANDS)
            {
                var PERIOD_SEARCH     = '.';
                var PERIOD_REPLACE    = ' period';
                var COMMA_SEARCH      = ',';
                var COMMA_REPLACE     = ' comma';
                var COLON_SEARCH      = ':';
                var COLON_REPLACE     = ' colon';
                var PARAGRAPH_SEARCH  = '\n\n';
                var PARAGRAPH_REPLACE = ' new paragraph ';

                transcriptToAppend = transcriptToAppend.replace(PERIOD_SEARCH,    PERIOD_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(COMMA_SEARCH,     COMMA_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(COLON_SEARCH,     COLON_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(PARAGRAPH_SEARCH, PARAGRAPH_REPLACE);
            }

            if(currentRecognitionResult.isFinal)
            {
                finalTranscript += transcriptToAppend;
                test.appendStringToFinalTranscript(transcriptToAppend);
            }
            else
            {
                interimTranscript += transcriptToAppend;
                test.appendStringToInterimTranscript(transcriptToAppend);
            }
        }
        //console.log("Interim: "+interimTranscript);
        //console.log("Final:   "+finalTranscript);

        console.log("Interim: "+test.getInterimTranscript());
        console.log("Final:   "+test.getFinalTranscript());

        document.getElementById(INTERIM_TRANSCRIPT_TEXTAREA_ID).value = test.getInterimTranscript();
        document.getElementById(FINAL_TRANSCRIPT_TEXTAREA_ID).value = test.getFinalTranscript();
    });

    function recognitionStartClickEventHandler()
    {
        console.log("recognitionStartClickEventHandler(): Entering function.");
        var elementToHideID = "button_sttStart";
        var elementToShowID = "button_sttStop";

        test.start();

        document.getElementById(elementToHideID).style.display="none";
        document.getElementById(elementToShowID).style.display="block";

        console.log("recognitionStartClickEventHandler(): Leaving function.");
    }

    function recognitionStopClickEventHandler()
    {
        console.log("recognitionStopClickEventHandler(): Entering function.");

        var elementToHideID = "button_sttStop";
        var elementToShowID = "button_sttStart";

        document.getElementById(elementToHideID).style.display="none";

        test.stop();

        document.getElementById(elementToShowID).style.display="block";

        console.log("recognitionStopClickEventHandler(): Leaving function.");
    }

</script>
</body>
</html>
