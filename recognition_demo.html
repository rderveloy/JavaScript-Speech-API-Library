<!--
-- Author:  Robert Derveloy
-- Written: 2013-01-15
-- 
-- Copyright (c) 2013-2015 -  Robert Derveloy
-- 
-- This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
-- To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/.
--
-->
<!DOCTYPE html>
<html>
<head>
    <title>JavaScript Speech API Library Demo</title>
</head>
<body>
<section id="section_NoJSWarning">
    <div id="div_NoJavaScriptWarning">
        <p>
            Sorry!  Your browser does not appear to have JavaScript enabled.  Please enable JavaScript in your browser for this site to function correctly.
        </p>
        <p>
            If your browser is incapable of running JavaScript, please see  <a href="http://caniuse.com/#feat=speech-synthesis" target="_blank">caniuse.com</a> for a list of compatible browsers.
        </p>
    </div>
</section>
<section id="section_STT">
    <div id="div_STTNotSupportedWarning" style="display:none;">
        <p>OOPS!</p>
        <p>Your browser does not appear to support the Speech Recognition API.  Please see  <a href="http://caniuse.com/#feat=speech-recognition" target="_blank">caniuse.com</a> for a list of capable browsers.</p>
    </div>
    <div id="div_sttInputs" style="display:none;">

        <button id='button_sttStart' onclick="recognitionStartClickEventHandler();">Start Recognition</button>
        <button id='button_sttStop' onclick="recognitionStopClickEventHandler();" style="display:none;">Stop Recognition</button>
    </div>
    <br />
    <br />
</section>
<footer>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
    <br />
            <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">
                JavaScript Speech API Library
            </span>
    by
    <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/rderveloy/JavaScript-Speech-API-Library/" property="cc:attributionName" rel="cc:attributionURL">Robert Derveloy</a>
    is licensed under a
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
        Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License
    </a>.
</footer>
<script src='SpeechAPILibrary.js'></script>
<script>
    var elementToHideID = "div_NoJavaScriptWarning";
    var elementToShowID = null;
    document.getElementById(elementToHideID).style.display="none";

    //Here we detect if speech synthesis is supported by the client browser:
    if(SpeechAPI.SpeechToText.isSupported())
    {
        //If it's supported, we need to update our UI:
        console.log("STT Supported!");
        elementToShowID = "div_sttInputs";
    }
    else
    {
        //If it's not supported, let the end user know:
        console.log("STT Not Supported!");
        elementToShowID = "div_STTNotSupportedWarning";
    }
    document.getElementById(elementToShowID).style.display="block";

</script>
<script>
    function ContinuousSession()
    {

        //Private constants
        var _CLASS_NAME           = function(){return "ContinuousSession";};
        var _EMPTY_STRING         = function(){return "";};
        var _STRING_TYPE_STRING   = function(){return "string";};
        var _FUNCTION_TYPE_STRING = function(){return "function";};

        //Private variables:
        var _startRequested    = false;
        var _stopRequested     = false;
        var _recognition       = null;
        var _interimTranscript = "";
        var _finalTranscript   = "";

        var _privateString = "private message";

        if(SpeechAPI.SpeechToText.isSupported())
        {
            _recognition                = new webkitSpeechRecognition();
            _recognition.continuous     = true;
            _recognition.interimResults = true;
        }

        //Private functions:
        function isFunction(desiredVariable)
        {
            var result = false;

            if(desiredVariable)
            {
                if(typeof(desiredVariable)==_FUNCTION_TYPE_STRING())
                {
                    result = true;
                }
            }

            return result;
        };

        //Public functions:
        this.getFinalTranscript = function()
        {
            return _finalTranscript;
        };

        this.resetFinalTranscriptToEmptyString = function()
        {
            _finalTranscript=_EMPTY_STRING();
        };

        this.assignStringToFinalTranscript = function(desiredText)
        {
            var FUNCTION_NAME = "assignStringToFinalTranscript()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            if(desiredText)
            {
                if(typeof(desiredText)==_STRING_TYPE_STRING())
                {
                    if(desiredText!=_EMPTY_STRING())
                    {
                        _finalTranscript = desiredText;
                    }
                    else
                    {
                        logMessage = LOG_PREFIX+"WARNING: The value of the desiredText variable was an empty string.  Using built-in reset function.";
                        console.log(logMessage);
                        this.resetFinalTranscriptToEmptyString();
                    }
                }
                else
                {
                    logMessage = LOG_PREFIX+"ERROR: The desiredText variable was not a string!  Aborting request.";
                    console.log(logMessage);
                }
            }
        };

        this.appendStringToFinalTranscript = function(desiredText)
        {
            var FUNCTION_NAME = "appendStringToFinalTranscript()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            if(desiredText)
            {
                if(typeof(desiredText)==_STRING_TYPE_STRING())
                {
                    if(desiredText!=_EMPTY_STRING())
                    {
                        _finalTranscript += desiredText;
                    }
                    else
                    {
                        logMessage = LOG_PREFIX+"WARNING: The value of the desiredText variable was an empty string.  Aborting request.";
                        console.log(logMessage);
                    }
                }
                else
                {
                    logMessage = LOG_PREFIX+"ERROR: The desiredText variable was not a string!  Aborting request.";
                    console.log(logMessage);
                }
            }
        };

        this.getInterimTranscript = function()
        {
            return _interimTranscript;
        };

        this.resetInterimTranscriptToEmptyString = function()
        {
            _interimTranscript=_EMPTY_STRING();
        };

        this.assignStringToInterimTranscript = function(desiredText)
        {
            var FUNCTION_NAME = "assignStringToInterimTranscript()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            if(desiredText)
            {
                if(typeof(desiredText)==_STRING_TYPE_STRING())
                {
                    if(desiredText!=_EMPTY_STRING())
                    {
                        _interimTranscript = desiredText;
                    }
                    else
                    {
                        logMessage = LOG_PREFIX+"WARNING: The value of the desiredText variable was an empty string.  Using built-in reset function.";
                        console.log(logMessage);
                        this.resetInterimTranscriptToEmptyString();
                    }
                }
                else
                {
                    logMessage = LOG_PREFIX+"ERROR: The desiredText variable was not a string!  Aborting request.";
                    console.log(logMessage);
                }
            }
        };

        this.appendStringToInterimTranscript = function(desiredText)
        {
            var FUNCTION_NAME = "appendStringToInterimTranscript()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            if(desiredText)
            {
                if(typeof(desiredText)==_STRING_TYPE_STRING())
                {
                    if(desiredText!=_EMPTY_STRING())
                    {
                        _interimTranscript += desiredText;
                    }
                    else
                    {
                        logMessage = LOG_PREFIX+"WARNING: The value of the desiredText variable was an empty string.  Aborting request.";
                        console.log(logMessage);
                    }
                }
                else
                {
                    logMessage = LOG_PREFIX+"ERROR: The desiredText variable was not a string!  Aborting request.";
                    console.log(logMessage);
                }
            }
        };

        this.getPrivateString = function()
        {
            return _privateString;
        };

        this.appendToPrivateString = function(desiredText)
        {
            if(desiredText)
            {
                _privateString+=desiredText;
            }
        };

        this.resetPrivateString = function()
        {
            _privateString=_EMPTY_STRING();
        };

        this.startRequested = function()
        {
            return _startRequested;
        };

        this.stopRequested = function()
        {
            return _stopRequested;
        };

        this.start = function(preserveTranscripts)
        {
            var FUNCTION_NAME = "start()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            _startRequested = true;
            _stopRequested  = false;

            if(!preserveTranscripts)
            {
                this.resetFinalTranscriptToEmptyString();
                this.resetInterimTranscriptToEmptyString();
                this.resetPrivateString();
            }

            if(_recognition)
            {

                try
                {
                    logMessage = LOG_PREFIX+"Requesting recognition start...";
                    console.log(logMessage);
                    _recognition.start();
                }
                catch(err)
                {
                    logMessage = LOG_PREFIX+"Exception encountered while requesting recognition start.";
                    console.log(logMessage);
                    console.log(err);
                }
            }
            else
            {
                logMessage = LOG_PREFIX+"ERROR: Recognition object was null!";
                console.log(logMessage);
            }
        };

        this.stop = function()
        {
            var FUNCTION_NAME = "stop()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            _stopRequested  = true;
            _startRequested = false;

            if(_recognition)
            {
                try
                {
                    logMessage = LOG_PREFIX+"Requesting recognition stop...";
                    console.log(logMessage);
                    _recognition.stop();
                }
                catch(err)
                {
                    logMessage = LOG_PREFIX+"Exception encountered while requesting recognition stop.";
                    console.log(logMessage);
                    console.log(err);
                }
            }
            else
            {
                logMessage = LOG_PREFIX+"ERROR: Recognition object was null!";
                console.log(logMessage);
            }
        };

        this.setEventHandler_onresult = function(desiredFunctionToExecute)
        {
            var FUNCTION_NAME = "setEventHandler_onresult()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            if(_recognition)
            {
                if(isFunction(desiredFunctionToExecute))
                {
                    _recognition.onresult=desiredFunctionToExecute;
                }
                else
                {
                    logMessage = LOG_PREFIX+"Error: Unable to assign onresult event handler. The desiredFunctionToExecute variable was not a function!";
                    console.log(logMessage);
                }
            }
            else
            {
                logMessage = LOG_PREFIX+"Error: Unable to assign onresult event handler. Recognition object not set.";
                console.log(logMessage);
            }
        };

        this.setEventHandler_onstart = function(desiredFunctionToExecute)
        {
            var FUNCTION_NAME = "setEventHandler_onstart()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            var sessionInstance = this;

            function onstart_scopePreserverWrapper(desiredFunctionToExecute, desiredSessionInstance)
            {
                return function onstart_scopePreserverWrapperReturnPayload(event)
                {
                    var PAYLOAD_FUNCTION_NAME = "onstart_scopePreserverWrapperReturnPayload()";
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Entering "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);
                    if(desiredSessionInstance)
                    {
                        try
                        {
                            desiredSessionInstance.appendToPrivateString("  Hi!  I've been appended by onstart_scopePreserverWrapperReturnPayload()!");
                            console.log(desiredSessionInstance.getPrivateString());
                        }
                        catch(caughtException)
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to work with the recognition session instance.";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }

                    if(desiredFunctionToExecute)
                    {
                        if(isFunction(desiredFunctionToExecute))
                        {
                            try
                            {
                                desiredFunctionToExecute(event);
                            }
                            catch (caughtException)
                            {
                                logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to execute the desired recognition.onstart event handler.";
                                console.log(logMessage);
                                console.log(caughtException);
                            }
                        }
                        else
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: The desiredFunctionToExecute variable was not a function!";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Leaving "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);
                };
            }

            if(_recognition)
            {
                try
                {
                    _recognition.onstart = onstart_scopePreserverWrapper(desiredFunctionToExecute,sessionInstance);
                }
                catch(caughtException)
                {
                    logMessage = LOG_PREFIX+"ERROR: An exception was encountered when attempting to assign the recognition.onstart event handler.";
                    console.log(logMessage);
                    console.log(caughtException);
                }

            }
            else
            {
                logMessage = LOG_PREFIX+"ERROR: Unable to assign onstart event handler. Recognition object not set.";
                console.log(logMessage);
            }
        };

        this.setEventHandler_onend = function(desiredFunctionToExecute)
        {
            var FUNCTION_NAME = "setEventHandler_onend()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            var sessionInstance = this;

            function onend_scopePreserverWrapper(desiredFunctionToExecute, desiredSessionInstance)
            {
                return function onend_scopePreserverWrapperReturnPayload(event)
                {
                    var PAYLOAD_FUNCTION_NAME = "onend_scopePreserverWrapperReturnPayload()";
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Entering "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);

                    if(desiredSessionInstance)
                    {
                        try
                        {
                            desiredSessionInstance.appendToPrivateString("  Hi!  I've been appended by onend_scopePreserverWrapperReturnPayload()!");
                            console.log(desiredSessionInstance.getPrivateString());
                        }
                        catch(caughtException)
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to work with the recognition session instance.";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }
                    if(desiredFunctionToExecute)
                    {
                        if(isFunction(desiredFunctionToExecute))
                        {
                            try
                            {
                                desiredFunctionToExecute(event);
                            }
                            catch (caughtException)
                            {
                                logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to execute the desired recognition.onend event handler.";
                                console.log(logMessage);
                                console.log(caughtException);
                            }
                        }
                        else
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: The desiredFunctionToExecute variable was not a function!";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Leaving "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);
                };
            }

            if(_recognition)
            {
                try
                {
                    _recognition.onend = onend_scopePreserverWrapper(desiredFunctionToExecute,sessionInstance);
                }
                catch(caughtException)
                {
                    logMessage = LOG_PREFIX+"ERROR: An exception was encountered when attempting to assign the recognition.onend event handler.";
                    console.log(logMessage);
                    console.log(caughtException);
                }
            }
            else
            {
                logMessage = LOG_PREFIX+"ERROR: Unable to assign onend event handler. Recognition object not set.";
                console.log(logMessage);
            }
        };

        this.setEventHandler_onerror = function(desiredFunctionToExecute)
        {
            var FUNCTION_NAME = "setEventHandler_onerror()";
            var LOG_PREFIX    = _CLASS_NAME()+"."+FUNCTION_NAME+": ";
            var logMessage    = null;

            var sessionInstance = this;

            function onerror_scopePreserverWrapper(desiredFunctionToExecute, desiredSessionInstance)
            {
                return function onerror_scopePreserverWrapperReturnPayload(event)
                {
                    var PAYLOAD_FUNCTION_NAME = "onerror_scopePreserverWrapperReturnPayload()";
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Entering "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);

                    if(desiredSessionInstance)
                    {
                        try
                        {
                            desiredSessionInstance.appendToPrivateString("  Hi!  I've been appended by "+PAYLOAD_FUNCTION_NAME+"!");
                            console.log(desiredSessionInstance.getPrivateString());
                        }
                        catch(caughtException)
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to work with the recognition session instance.";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }
                    if(desiredFunctionToExecute)
                    {
                        if(isFunction(desiredFunctionToExecute))
                        {
                            try
                            {
                                desiredFunctionToExecute(event);
                            }
                            catch (caughtException)
                            {
                                logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: An exception was encountered when attempting to execute the desired recognition.onerror event handler.";
                                console.log(logMessage);
                                console.log(caughtException);
                            }
                        }
                        else
                        {
                            logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": ERROR: The desiredFunctionToExecute variable was not a function!";
                            console.log(logMessage);
                            console.log(caughtException);
                        }
                    }
                    logMessage = LOG_PREFIX+PAYLOAD_FUNCTION_NAME+": Leaving "+PAYLOAD_FUNCTION_NAME+".";
                    console.log(logMessage);
                };
            }

            if(_recognition)
            {
                try
                {
                    _recognition.onerror = onerror_scopePreserverWrapper(desiredFunctionToExecute,sessionInstance);
                }
                catch(caughtException)
                {
                    logMessage = LOG_PREFIX+"ERROR: An exception was encountered when attempting to assign the recognition.onerror event handler.";
                    console.log(logMessage);
                    console.log(caughtException);
                }
                /*
                if (isFunction(desiredFunctionToExecute))
                {
                    _recognition.onerror = desiredFunctionToExecute;
                }
                else
                {
                    logMessage = LOG_PREFIX+"Error: Unable to assign onerror event handler. The desiredFunctionToExecute variable was not a function!";
                    console.log(logMessage);
                }
                */
            }
            else
            {
                logMessage = LOG_PREFIX+"Error: Unable to assign onerror event handler. Recognition object not set.";
                console.log(logMessage);
            }
        };

    }

</script>
<script>

    //TODO: Continue session when ended without request or error.
    //TODO: Appropriately hide/show buttons in onstart and onend event handlers.
    //TODO: Reset final transcript when user ends session.

    var interimTranscript = "";
    var finalTranscript   = "";
    var IGNORE_SPOKEN_PUNCTUATION_COMMANDS = true;
    var test = new ContinuousSession();


    test.setEventHandler_onend(function onEndEventHandler(event){
        console.log("Recognition ended.");
        console.log("Stop Requested: "+test.stopRequested());

        var elementToHideID = "button_sttStop";
        var elementToShowID = "button_sttStart";

        document.getElementById(elementToHideID).style.display="none";
        document.getElementById(elementToShowID).style.display="block";
    });

    test.setEventHandler_onstart(function onStartEventHandler(event){
        console.log("Recognition started.");
        console.log("Start Requested: "+test.startRequested());
    });

    test.setEventHandler_onerror(function onErrorEventHandler(event){
        console.log("Recognition error!");
        console.log(event);
    });

    test.setEventHandler_onresult(function onResultEventHandler(event){
        console.log("Recognition result!");

        console.log(event);

        var resultIndex       = event.resultIndex;
        var resultArrayLength = event.results.length;

        interimTranscript = "";
        test.resetInterimTranscriptToEmptyString();

        for (var currentIndex=resultIndex; currentIndex < resultArrayLength; ++currentIndex)
        {
            var currentRecognitionResult             = event.results[currentIndex];
            var currentRecognitionResultAlternative  = currentRecognitionResult[0];
            var transcriptToAppend                   = currentRecognitionResultAlternative.transcript;

            if(IGNORE_SPOKEN_PUNCTUATION_COMMANDS)
            {
                var PERIOD_SEARCH     = '.';
                var PERIOD_REPLACE    = ' period';
                var COMMA_SEARCH      = ',';
                var COMMA_REPLACE     = ' comma';
                var COLON_SEARCH      = ':';
                var COLON_REPLACE     = ' colon';
                var PARAGRAPH_SEARCH  = '\n\n';
                var PARAGRAPH_REPLACE = ' new paragraph ';

                transcriptToAppend = transcriptToAppend.replace(PERIOD_SEARCH,    PERIOD_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(COMMA_SEARCH,     COMMA_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(COLON_SEARCH,     COLON_REPLACE);
                transcriptToAppend = transcriptToAppend.replace(PARAGRAPH_SEARCH, PARAGRAPH_REPLACE);
            }

            if(currentRecognitionResult.isFinal)
            {
                finalTranscript += transcriptToAppend;
                test.appendStringToFinalTranscript(transcriptToAppend);
            }
            else
            {
                interimTranscript += transcriptToAppend;
                test.appendStringToInterimTranscript(transcriptToAppend);
            }
        }
        //console.log("Interim: "+interimTranscript);
        //console.log("Final:   "+finalTranscript);

        console.log("Interim: "+test.getInterimTranscript());
        console.log("Final:   "+test.getFinalTranscript());
    });

    function recognitionStartClickEventHandler()
    {
        console.log("recognitionStartClickEventHandler(): Entering function.");
        var elementToHideID = "button_sttStart";
        var elementToShowID = "button_sttStop";

        test.start();

        document.getElementById(elementToHideID).style.display="none";
        document.getElementById(elementToShowID).style.display="block";

        console.log("recognitionStartClickEventHandler(): Leaving function.");
    }

    function recognitionStopClickEventHandler()
    {
        console.log("recognitionStopClickEventHandler(): Entering function.");

        var elementToHideID = "button_sttStop";
        var elementToShowID = "button_sttStart";

        document.getElementById(elementToHideID).style.display="none";

        test.stop();

        document.getElementById(elementToShowID).style.display="block";

        console.log("recognitionStopClickEventHandler(): Leaving function.");
    }

</script>
</body>
</html>
